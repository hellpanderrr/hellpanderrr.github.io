<html>
  <head>
    <title>Read Text File</title>
    <script src="./data.js"></script>
  </head>
  <body>
    <input type="file" name="inputfile" id="inputfile" />
    <br />
    <form id="frm1" onsubmit="return false">
      <div class="form-group">
        <textarea
          id="text_to_transcribe"
          name="text_to_transcribe"
          required=""
          autofocus=""
          style="height: 101px; overflow: auto; resize: vertical; width: 300px"
        >Hat Herr MÃ¼ller eine Frau? Ja, er hat eine Frau. Wie</textarea>
        <input type="button" id="clear_button" />
        <div class="btn-group btn-block" role="group">
          <input
            id="submit"
            class="btn btn-primary btn-block"
            name="submit"
            type="submit"
            value="Show transcription"
            title="or Ctrl+Enter while in the text area"
          />
        </div>
      </div>
    </form>
    <div 
      id="result"
      style="overflow: auto; resize: vertical; width: 300px"
    ></div>
    <pre id="output"></pre>
    <script type="text/javascript">
      function sanitize(text) {

        return text.replace(/[^\p{L}]/gu, "");
      }

      function transcribe() {
        text = document.getElementById("text_to_transcribe").value;
        separated = text.split(" ");
        result = separated.map((i) => get_ipa(i));
        div = document.getElementById("result")
        div.innerHTML = '';
        result.reverse().map(x=>div.insertAdjacentHTML('afterbegin',x));
        console.log(result)
        document.getElementById("result").value = result.join(" ");
      }
      var form = document.getElementById("frm1");
      function handleForm(event) {
        event.preventDefault();
      }
      form.addEventListener("submit", transcribe);

      function get_ipa(text) {
        clean_text = sanitize(text)
        ret = dict.get(clean_text)
        if (ret){
        	ret = unescape(ret)
        }
        if (!ret) {
          ret = dict.get(clean_text.toLowerCase());
        }
        split = text.split(/([\p{L}]+)/gu)
        index_in_split = split.map((x, n)=>(x == clean_text && n)).filter(Boolean)[0]
        split[index_in_split] = ret
        ret = split.join('')
        
        if (!ret) {
          
          return `<span style='color:red;'>${text} </span>`;
        }
        return `<span>${ret} </span>`;
      }

      const splitAndAppend = (str, delim, count) => {
        const arr = str.split(delim);
        return [...arr.splice(0, count), arr.join(delim)];
      };
      let text = "";

      function process_lexicon(text, sep = "\r\n") {
        lines = text.split(sep).map((i) => splitAndAppend(i, " ", 1));
        ret = new Map(lines.map((i) => [i[0], i[1].split(" ").join("")]));
        return ret;
      }

      fetch("./data/german_ipa.txt")
        .then(function (response) {
          return response;
        })
        .then(function (data) {
          return data.text();
        })
        .then(function (Normal) {
          text = Normal;
          console.log("loaded text");
          dict = process_lexicon(text, sep='\n');
          console.log("created dict");
        })
        .catch(function (err) {
          console.log("Fetch problem show: " + err.message);
        });
        
        
		window.addEventListener('load', function() {
			lines = lines.filter(x=>!x[1].includes('|'))
		    dict = new Map(lines);
		    console.log('loaded dict')
		})


      document
        .getElementById("inputfile")
        .addEventListener("change", function () {
          var fr = new FileReader();
          fr.onload = function () {
            text = fr.result;
            dict = process_lexicon(text);
            alert("Success.");
          };

          fr.readAsText(this.files[0]);
        });
    </script>
  </body>
</html>
